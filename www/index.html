<!DOCTYPE html>
<html>

<head>
    <title>WAACS QR Code</title>
    <meta charset="utf-8">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="qrcode.min.js"></script>
    <style type="text/css">
        * {
            box-sizing: border-box;
            cursor: none;
            /* CSS3 */
            user-select: none;
            /* Firefox */
            -moz-user-select: none;
            /* Safari、Chromeなど */
            -webkit-user-select: none;
            /* IE10かららしい */
            -ms-user-select: none;
        }

        body {
            width: 800px;
            height: 480px;
            margin: 0px;
            overflow: hidden;
        }

        #info_area {
            width: 640px;
            height: calc(480px - 160px);
            float: left;
            padding: 0px 20px;
            background-color: lightcyan;
            font-size: 32px;
        }

        #qr_area {
            width: calc(800px - 640px);
            height: calc(800px - 640px);
            background-color: lightyellow;
            float: right;
            ;
            padding: 10px;
        }

        #qr_img {
            height: calc(800px - 640px - (2 * 10px));
            width: calc(800px - 640px - (2 * 10px));
        }

        #blank_area1 {
            width: 640px;
            height: calc(800px - 640px);
            background-color: lightpink;
            float: left;
            display: flex;
            ;
        }

        #blank_area2 {
            height: calc(480px - 160px);
            width: calc(800px - 640px);
            background-color: lightgreen;
            float: right;
        }
    </style>
    <script type="text/javascript">
        const GET_LATEST_TOKEN_URL = "./get_latest_token.php";
        var qrImg;
        var qrArea;
        var statusArea;
        var clockArea;
        var qrUpdateTimeArea;
        var qrCode;
        var lastToken = null;
        var lastIssuanceTime = null;
        var lastActivationTime = null;
        var isQrUpdating = false;
        window.onload = function() {
            qrImg = document.getElementById("qr_img");
            qrImg.style.display = "none";
            qrArea = document.getElementById("qr_area");
            qr = new QRCode(qrImg, {
                width: qrImg.clientWidth,
                height: qrImg.clientHeight
            });
            clockArea = document.getElementById("clock_area");
            qrUpdateTimeArea = document.getElementById("qr_update_time_area");
            statusArea = document.getElementById("status_area");
            setQrcode();
            setClock();
            displayQrcode();
            setInterval(setQrcode, 100);
            setInterval(setClock, 100);
            setInterval(displayQrcode, 100);
        }

        function setQrcode() {
            if (isQrUpdating || isQrDisplaying) {
                return;
            }
            var req;
            if (window.XMLHttpRequest) {
                req = new XMLHttpRequest();
            } else if (window.ActiveXOject) {
                req = new ActiveXObject('Microsoft.XMLHTTP');
            } else {
                statusArea.innerHTML = "AJAXが使えません";
                return;
            }
            req.open("GET", GET_LATEST_TOKEN_URL, true);
            req.onreadystatechange = function() {
                if (req.readyState == 4) {
                    if (req.status == 200) {
                        try {
                            //次回以降のsetQrcode()をブロック
                            isQrUpdating = true;
                            var resp = JSON.parse(req.responseText);
                            var token = resp["token"];
                            var issuanceTimeStr = resp["issuance_time"];
                            issuanceTime = new Date(issuanceTimeStr.replace(/-/g, "/"));
                            var activationTimeStr = resp["activation_time"];
                            if (token == null) {
                                return;
                            }
                            //取得した最新トークンが前回更新したものと違うとき更新
                            if (lastToken == null || token != lastToken) {
                                updateQrcode(token);
                                lastToken = token;
                                lastIssuanceTime = issuanceTime;
                                statusArea.innerHTML = "携帯端末をかざしてください";
                            }
                            //activation_timeが存在するとき5秒間QRコード表示
                            if (activationTimeStr != null) {
                                activationTime = new Date(activationTimeStr.replace(/-/g, "/"));
                                lastActivationTime = activationTime;
                                qrUpdateTimeArea.innerHTML = formatDate(activationTime);
                                displayQrcode(activationTime + 5 * 1000);
                            }
                        } catch (e) {
                            statusArea.innerHTML = "エラー: " + e.message;
                        } finally {
                            isQrUpdating = false;
                        }
                    } else {
                        statusArea.innerHTML = "トークン取得失敗";
                    }
                }
            };
            req.send(null);
        }

        function updateQrcode(token) {
            qr.clear();
            qr.makeCode("https://waacs.under-mu.com/secure.waacs.under-mu.com/" + token + "/");
        }

        function displayQrcode(end) {
            if (new Date() <= end) {
                isQrDisplaying = true;
                statusArea.innerHTML = "QRコードをスキャンしてください";
                qrImg.style.display = "";
                setTimeout(function() {
                    displayQrcode(end)
                }, 100);
            } else {
                qrImg.style.display = "none";
                statusArea.innerHTML = "お待ち下さい";
                isQrDisplaying = false;
            }
        }

        function setClock() {
            var now = new Date();
            clockArea.innerHTML = formatDate(now);
        }

        function formatDate(date) {
            var year = zeroPadding(date.getFullYear(), 4);
            var month = zeroPadding(date.getMonth() + 1, 2);
            var day = zeroPadding(date.getDate(), 2);
            var hour = zeroPadding(date.getHours(), 2);
            var minute = zeroPadding(date.getMinutes(), 2);
            var second = zeroPadding(date.getSeconds(), 2);
            return year + "/" + month + "/" + day + " " + hour + ":" + minute + ":" + second;
        }

        function zeroPadding(num, digit) {
            var zeros = "";
            for (var i = 0; i < digit; i++) {
                zeros += "0";
            }
            return (zeros + num).substr(-digit);
        }
    </script>
</head>

<body>
    <div id="blank_area1">
    </div>
    <div id="qr_area">
        <div id="qr_img"></div>
    </div>
    <div id="info_area">
        <p>
            現在時刻:
            <span id="clock_area"></span>
        </p>
        <p>
            QR更新時間:
            <span id="qr_update_time_area"></span>
        </p>
        <p>
            状態:
            <span id="status_area"></span>
        </p>
    </div>

    <div id="blank_area2">
    </div>
</body>

</html>
